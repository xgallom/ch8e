#include "memory.h"

#include <stdio.h>
#include <assert.h>

static uint8_t memory[MEMORY_SIZE] = {
	0xf0, 0x90, 0x90, 0x90, 0xf0, // 0
	0x20, 0x60, 0x20, 0x20, 0x70, // 1
	0xf0, 0x10, 0xf0, 0x80, 0xf0, // 2
	0xf0, 0x10, 0xf0, 0x10, 0xf0, // 3
	0x90, 0x90, 0xf0, 0x10, 0x10, // 4
	0xf0, 0x80, 0xf0, 0x10, 0xf0, // 5
	0xf0, 0x80, 0xf0, 0x90, 0xf0, // 6
	0xf0, 0x10, 0x20, 0x40, 0x40, // 7
	0xf0, 0x90, 0xf0, 0x90, 0xf0, // 8
	0xf0, 0x90, 0xf0, 0x10, 0xf0, // 9
	0xf0, 0x90, 0xf0, 0x90, 0x90, // A
	0xe0, 0x90, 0xe0, 0x90, 0xe0, // B
	0xf0, 0x80, 0x80, 0x80, 0xf0, // C
	0xe0, 0x90, 0x90, 0x90, 0xe0, // D
	0xf0, 0x80, 0xf0, 0x80, 0xf0, // E
	0xf0, 0x80, 0xf0, 0x80, 0x80  // F
};

uint8_t *mem_at(uint16_t addr)
{
	assert(addr < MEMORY_SIZE);

	return &memory[addr];
}

static uint8_t *mem_end(uint16_t addr)
{
	return &memory[addr];
}

static int has_data_in_block(uint16_t addr)
{
	uint32_t
		*mem = (uint32_t *) mem_at(addr), 
		*end = (uint32_t *) mem_end(addr + 0x10);

	while(mem < end) {
		if(*mem)
			return 1;

		++mem;
	}

	return 0;
}

void mem_dump()
{
	fprintf(stderr, "\nDumping memory:\n");

	uint16_t addr = 0;

	int found = 1;

	while(addr < MEMORY_SIZE) {
		if(has_data_in_block(addr)) {
			if(!found)
				fprintf(stderr, "\n");

			fprintf(stderr, " %04x :", addr);

			for(uint16_t end = addr + 0x10; addr < end; ++addr)
				fprintf(stderr, " %02x", memory[addr]);

			fprintf(stderr, "\n");
			found = 1;
		}
		else {
			addr += 0x10;
			found = 0;
		}
	}

	fprintf(stderr, "\n");
}

